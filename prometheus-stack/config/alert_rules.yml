# Группы правил
groups:
  # ----------------------------------------------------------------------------
  # УРОВЕНЬ 1: ДОСТУПНОСТЬ
  # ----------------------------------------------------------------------------
  - name: availability
    rules:
      - alert: InstanceDown
        # Метрика 'up'. Значения: 1 = ОК, 0 = ОШИБКА.
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Сервис {{ $labels.job }} не отвечает"
          description: "Недоступность инстанса {{ $labels.instance }} (job: {{ $labels.job }}) более 1 минуты."

  # ----------------------------------------------------------------------------
  # УРОВЕНЬ 2: РЕСУРСЫ (CPU)
  # ----------------------------------------------------------------------------
  - name: host_resources
    rules:
      # === [LINUX] ВАРИАНТ 1: ПРОСТОЙ (BASIC) ===
      # Метод: Группировка через 'by (instance)'.
      # Логика: Расчет среднего значения изолированно для каждого сервера.
      # Результат: Сохранение ТОЛЬКО меток instance и job. Удаление остальных метаданных.
      - alert: LinuxHostHighCpuLoad
        expr: 100 - avg by (instance, job) (rate(node_cpu_seconds_total{job="node-exporter", mode="idle"}[5m])) * 100 > 80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Высокая нагрузка CPU (Linux)"
          description: "Загрузка процессора на сервере {{ $labels.instance }} > 80%."

      # === [LINUX] ВАРИАНТ 2: ПРОДВИНУТЫЙ (PRO) ===
      # Метод: Группировка через 'without'.
      # Результат: Сохранение ВСЕХ пользовательских меток (env, team, region). 
      # Числовой результат идентичен варианту 1.
      #
      # - alert: HostHighCpuLoad_Pro
      #   expr: 100 - avg without (cpu, mode) (rate(node_cpu_seconds_total{job="node-exporter", mode="idle"}[5m])) * 100 > 80
      #   for: 1m
      #   labels:
      #     severity: warning
      #   annotations:
      #     summary: "CPU Load: {{ $labels.instance }}"
      #     description: "Перегрузка сервера {{ $labels.instance }}."

      # ------------------------------------------------------------------------

      # === [WINDOWS] ВАРИАНТ 1: ПРОСТОЙ ===
      - alert: WindowsHostHighCpuLoad
        expr: 100 - avg by (instance, job) (rate(windows_cpu_time_total{job="windows-exporter", mode="idle"}[5m])) * 100 > 80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Высокая нагрузка CPU (Windows)"
          description: "Загрузка процессора на сервере {{ $labels.instance }} > 80%."

      # === [WINDOWS] ВАРИАНТ 2: ПРОДВИНУТЫЙ ===
      # Учет специфики имен меток в Windows Exporter.
      #
      # - alert: WinHostHighCpuLoad_Pro
      #   expr: 100 - avg without (core, mode) (rate(windows_cpu_time_total{job="windows-exporter", mode="idle"}[5m])) * 100 > 80
      #   for: 1m
      #   labels:
      #     severity: warning
      #   annotations:
      #     summary: "CPU Load (Win): {{ $labels.instance }}"
      #     description: "Перегрузка сервера {{ $labels.instance }}."