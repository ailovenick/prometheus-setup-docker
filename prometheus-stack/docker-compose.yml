services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    volumes:
      # [CONFIG] Передаем файл настроек (кого опрашивать, как часто).
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      
      # [PERSISTENCE] Хранилище временных рядов (TSDB).
      # Здесь лежат все твои графики за прошлые дни/месяцы.
      # ПРИМЕЧАНИЕ ПО ПРАВАМ (Permissions):
      # 1. Если используешь путь (./data) - это Bind Mount. Нужно вручную дать права
      #    пользователю внутри контейнера: `sudo chown -R 65534:65534 ./data`.
      # 2. Если использовать ИМЕНОВАННЫЙ ТОМ (например, prometheus_data:/prometheus),
      #    то Docker сам выставит нужные права, но файлы будут скрыты в недрах Docker.
      - ./data:/prometheus

    command:
      # Указываем путь к конфигу внутри контейнера.
      - '--config.file=/etc/prometheus/prometheus.yml'
      # Указываем, где хранить базу данных (совпадает с путем в volumes выше).
      - '--storage.tsdb.path=/prometheus'
      # Папки для служебных шаблонов (нужны для работы веб-интерфейса).
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    
    # Режим "host" для упрощения: Prometheus видит всех соседей на localhost.
    network_mode: "host"

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    volumes:
      # Конфиг: куда слать уведомления (Telegram, Email и т.д.).
      - ./config/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      # Хранилище состояний: заглушенные алерты (Silences).
      # ПРИМЕЧАНИЕ ПО ПРАВАМ:
      # Требует прав пользователя 'nobody' (UID 65534), как и Prometheus.
      # `sudo chown -R 65534:65534 ./alertmanager_data`
      - ./alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    network_mode: "host"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    volumes:
      # Здесь хранятся созданные тобой дашборды и настройки пользователей.
      # База данных SQLite (grafana.db) лежит именно тут.
      # ПРИМЕЧАНИЕ ПО ПРАВАМ:
      # Для Bind Mount (./grafana_data) нужно отдать папку пользователю Grafana:
      # `sudo chown -R 472:472 ./grafana_data`
      - ./grafana_data:/var/lib/grafana
    environment:
      # Настройки "из коробки" через переменные окружения.
      - GF_SECURITY_ADMIN_USER=admin     # Логин администратора
      - GF_SECURITY_ADMIN_PASSWORD=admin # Пароль администратора
      - GF_USERS_ALLOW_SIGN_UP=false     # Запрет регистрации новых пользователей
    network_mode: "host"

  # Локальный агент для самого сервера мониторинга (чтобы мониторить мониторинг) подробные комментарии в node-exporter.
  node-exporter:
    image: prom/node-exporter:latest
    container_name: prometheus_node_exporter
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    network_mode: "host"
    pid: "host"

