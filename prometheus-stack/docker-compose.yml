services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    volumes:
      # [CONFIG] Передача основного файла конфигурации.
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      # [RULES] Передача файла правил алертинга.
      - ./config/alert_rules.yml:/etc/prometheus/alert_rules.yml
      
      # [PERSISTENCE] Хранилище временных рядов (TSDB).
      # Назначение: сохранение исторических данных (графики за прошлые периоды).
      # ПРИМЕЧАНИЕ ПО ПРАВАМ (Permissions):
      # 1. При использовании Bind Mount (./data): необходимость ручной установки прав
      #    для пользователя внутри контейнера: `sudo chown -R 65534:65534 ./data`.
      # 2. При использовании Named Volume (prometheus_data): автоматическое управление правами Docker,
      #    хранение файлов во внутренних структурах Docker.
      - ./data:/prometheus

    command:
      # Указание пути к файлу конфигурации внутри контейнера.
      - '--config.file=/etc/prometheus/prometheus.yml'
      # Указание директории для хранения базы данных.
      - '--storage.tsdb.path=/prometheus'
      # Настройка путей для служебных библиотек и шаблонов консоли (для веб-интерфейса).
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    
    # Режим сети "host".
    # Назначение: упрощение обнаружения сервисов на localhost.
    network_mode: "host"

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    volumes:
      # Конфигурация: параметры отправки уведомлений (Telegram, Email).
      - ./config/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      # Хранилище состояний: данные о заглушённых алертах (Silences).
      # ПРИМЕЧАНИЕ ПО ПРАВАМ:
      # Требование прав пользователя 'nobody' (UID 65534).
      # Команда: `sudo chown -R 65534:65534 ./alertmanager_data`
      - ./alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    network_mode: "host"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    volumes:
      # Хранилище пользовательских данных (дашборды, база grafana.db).
      # ПРИМЕЧАНИЕ ПО ПРАВАМ:
      # Для Bind Mount (./grafana_data) требование прав пользователя Grafana (UID 472).
      # Команда: `sudo chown -R 472:472 ./grafana_data`
      - ./grafana_data:/var/lib/grafana
    environment:
      # Инициализация параметров через переменные окружения.
      - GF_SECURITY_ADMIN_USER=admin     # Логин администратора
      - GF_SECURITY_ADMIN_PASSWORD=admin # Пароль администратора
      - GF_USERS_ALLOW_SIGN_UP=false     # Отключение регистрации новых пользователей
    network_mode: "host"

  # Локальный агент (Node Exporter) для мониторинга самого сервера мониторинга.
  # Детальное описание в разделе node-exporter.
  node-exporter:
    image: prom/node-exporter:latest
    container_name: prometheus_node_exporter
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    network_mode: "host"
    pid: "host"