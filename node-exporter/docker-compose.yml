services:
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    # Политика перезапуска: перезагрузка (кроме явной остановки manual stop).
    restart: unless-stopped
    
    # [VOLUMES] Монтирование файловых систем хоста.
    # Примечание: отдельное монтирование /proc и /sys (необходимость из-за отсутствия рекурсивности bind-mount).
    # Обоснование: генерация данных ядром "на лету" в виртуальных ФС.
    # Цель: доступ к данным о процессах и оборудовании хоста.
    volumes:
      - /proc:/host/proc:ro # Виртуальная ФС ядра (информация о процессах). Режим: Read Only.
      - /sys:/host/sys:ro   # Виртуальная ФС (параметры ядра и оборудования).
      - /:/rootfs:ro        # Корневая ФС хоста (мониторинг дискового пространства).

    command:
      # [FLAGS] Переопределение системных путей.
      # Указание экспортеру использовать смонтированные пути (/host/proc, /host/sys) вместо контейнерных.
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      
      # [FILTER] Фильтрация файловых систем.
      # Исключение виртуальных путей Docker (aufs, tmpfs, overlay) для чистоты метрик.
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'

    # [NETWORK] Сетевой режим: host.
    # Прямое использование сетевого стека хоста (отсутствие NAT).
    # Доступность экспортера на порту :9100 хоста.
    network_mode: "host"

    # [PID] Пространство имен процессов: host.
    # Назначение: синхронизация Process ID (PID) между контейнером и хостом.
    # Отличие от volumes: volumes обеспечивают чтение файлов, pid: "host" — валидность системных вызовов к процессам.
    # Предотвращение ошибок сбора метрик, зависящих от контекста процессов.
    pid: "host"